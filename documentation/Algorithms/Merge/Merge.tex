\documentclass[../Algorithms.tex]{subfiles}

\begin{document}
    \section{Semistructured Merge}

    \subsection{Early Concepts}

    \begin{enumerate}
        \item $A_L$ and $A_R$ are the sets of all the nodes added by left and right, respectively
        \item $D_L$ and $D_R$ are the sets of all the nodes deleted by left and right, respectively
        \item Every node's origin is set to UNKNOWN beforehand
    \end{enumerate}

    \subsection{Merge Algorithms}

    \begin{algorithm}[H]
        \caption{Merge Files}

        \KwIn{l, b, r, o}

        \BlankLine
        \SetKwFunction{ftt}{fileToTree}
        \SetKwFunction{mt}{mergeTrees}
        \SetKwFunction{gah}{getActiveHandlers}
        \SetKwFunction{ttt}{treeToText}

        \uIf{$l.content = b.content$}{
            $o.content \leftarrow r.content$\;
        }
        \uElseIf{$b.content = r.content \lor l.content = r.content$}{
            $o.content \leftarrow l.content$\;
        }
        \Else{
            $L \leftarrow \ftt{l}$\;
            $B \leftarrow \ftt{b}$\;
            $R \leftarrow \ftt(r)$\;

            \BlankLine
            $M \leftarrow \mt{L, B, R}$\;

            \BlankLine
            $H \leftarrow \gah{}$\;
            \ForEach{$h \in H$}{
                $h.handle(M)$\;
            }

            \BlankLine
            $o.content \leftarrow \ttt{M}$\;
        }
    \end{algorithm}

    \SetKwFunction{mn}{mergeNodes}
    \SetKwFunction{rdn}{removeDeletedNodes}
    \SetKwFunction{ulb}{updateLeafBodies}

    \begin{algorithm}[H]
        \caption{Merge Trees}

        \KwIn{L, B, R}
        \KwOut{result of merging left, base and right trees}

        \BlankLine

        $L.origin = LEFT$\;
        $B.origin = BASE$\;
        $R.origin = RIGHT$\;

        \BlankLine
        $LB \leftarrow \mn{L, B, LB-STEP}$\;
        $M \leftarrow \mn{LB, R, LBR-STEP}$\;

        \BlankLine
        $D_B \leftarrow D_{L} \cap D_{R}$\;
        \ForEach{$d \in D_B$}{
            \rn{d, M}\;
        }

        \BlankLine
        \ulb{M}\;

        \BlankLine
        \KwRet{M}\;
    \end{algorithm}

    \SetKwFunction{tm}{textualMerge}

    \begin{algorithm}[H]
        \caption{Update Leaf Bodies}

        \KwIn{T}

        \BlankLine
        \ForEach{$t \in T.children$}{
            \ulb{t}\;
        }

        \BlankLine
        \If{$T.children = \emptyset \land SEPARATOR \in T.body$}{
            $l, b, r \leftarrow split(T.body, SEPARATOR)$\;
            $l \leftarrow l - MARKER$\;
            $T.body \leftarrow \tm{l, b, r}$\;

            %TODO: decide wether to do the same as above for the special token prefix
        }
    \end{algorithm}

    \begin{algorithm}[H]
        \caption{Merge Nodes}

        \KwIn{A, B, step}
        \KwOut{result of merging nodes A and B}

        \BlankLine
        \SetKwFunction{mc}{markContributions}
        \SetKwFunction{ls}{leftSiblings}
        \SetKwFunction{rs}{rightSiblings}

        \lIf{A = null}{ \KwRet{B} }
        \lIf{B = null}{ \KwRet{A} }

        \BlankLine
        \If{$A.type \neq B.type \lor A.id \neq B.id$}{
            \KwRet{null}\;
        }

        \BlankLine
        $M \leftarrow A$\;
        $M.origin \leftarrow B.origin$\;

        \BlankLine
        \If{$A.children = \emptyset \land B.children = \emptyset$}{
            \uIf{$MARKER \in A.body$}{
                $M.body \leftarrow A.body + B.body$\;
            }
            \uElseIf{step = LB-STEP}{
                $M.body \leftarrow MARKER + A.body + SEPARATOR + B.body + SEPARATOR$\;
            }
            \uElseIf{A.origin = LEFT}{
                $M.body \leftarrow MARKER + A.body + SEPARATOR + SEPARATOR + B.body$\;
            }
            \Else{
                $M.body \leftarrow MARKER + SEPARATOR + A.body + SEPARATOR + B.body$\;
            }

            %TODO: decide wether to do the same as above for the special token prefix

            \BlankLine
            \KwRet{M}\;
        }

        \BlankLine
        \If{$A.children \neq \emptyset \land B.children \neq \emptyset$}{
            \ForEach{$b \in B.children$}{
                $a \leftarrow find(a \in A.children \rightarrow a.type = b.type \land a.id = b.id)$\;

                \BlankLine
                \lIf{a.origin = UNKNOWN}{
                    $a.origin \leftarrow A.origin$
                }
                \lIf{b.origin = UNKNOWN}{
                    $b.origin \leftarrow B.origin$
                }

                \BlankLine
                \uIf{a = null}{
                    \uIf{step = LB-STEP}{
                        $D_L \leftarrow D_L \cup b$\;
                    }
                    \Else{
                        $A_R \leftarrow A_R \cup b$\;
                    }
                }
                \ElseIf{step = LB-STEP $\land \: a \in A_L$}{
                    $A_R \leftarrow A_R \cup b$\;
                }

                \BlankLine
                $m \leftarrow \mn{a, b, step}$\;
                $M.children \leftarrow M.children \cup m$\;
            }

            \BlankLine
            \ForEach{$a \in A.children$}{
                $b \leftarrow find(b \in B.children \rightarrow a.type = b.type \land a.id = b.id)$\;
                \If{b = null}{
                    $ls \leftarrow \ls{a}$\;
                    $rs \leftarrow \rs{a}$\;
                    $M.children \leftarrow ls \cup a \cup rs$\;

                    \BlankLine
                    \lIf{step = LB-STEP}{
                        $A_L \leftarrow A_L \cup a$
                    }
                    \lElseIf{$a \notin A_L$}{
                        $D_R \leftarrow D_R \cup a$
                    }
                }
            }

            \BlankLine
            \KwRet{M}\;
        }

        \BlankLine
        \KwRet{null};
    \end{algorithm}
\end{document}