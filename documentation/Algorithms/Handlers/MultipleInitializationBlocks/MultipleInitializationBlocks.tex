\documentclass[../../Algorithms.tex]{subfiles}

\begin{document}
    \section{Multiple Initialization Blocks Handler}

    \subsection{Handler Algorithm}

    \begin{algorithm}[H]
        \caption{Handle}

        \KwIn{L, B, R, M}
        \SetKwFunction{en}{editedNodes}
        \SetKwFunction{an}{addedNodes}
        \SetKwFunction{dn}{deletedNodes}

        \BlankLine
        $A_L \leftarrow \{l \in L \mid (\lnot \exists b \in B)(l.id = b.id)\}$\;
        $A_R \leftarrow \{r \in R \mid (\lnot \exists b \in B)(r.id = b.id)\}$\;
        $D_B \leftarrow \{b \in B \mid (\lnot \exists l \in L)(b.id = l.id) \land (\lnot \exists r \in R)(b.id = r.id)\}$\;

        \BlankLine
        %TODO: remove duplicates
        $IB_L \leftarrow \{n \in A_L \mid n.type = INITBLOCK\}$\;
        $IB_R \leftarrow \{n \in A_R \mid n.type = INITBLOCK\}$\;
        $IB_B \leftarrow \{n \in D_B \mid n.type = INITBLOCK\}$\;

        \BlankLine
        $E_L \leftarrow \en{$IB_L$, $IB_B$}$\;
        $E_R \leftarrow \en{$IB_R$, $IB_B$}$\;

        \BlankLine
        $D_L \leftarrow \dn{$IB_L$, $IB_B$, $E_L$}$\;
        $D_R \leftarrow \dn{$IB_R$, $IB_B$, $E_R$}$\;
        
        \BlankLine
        \ForEach{$b \in IB_B$}{
            $l \leftarrow E_L.getValue(b)$\;
            $r \leftarrow E_R.getValue(b)$\;

            \BlankLine
            \uIf{$l \neq null \land r \neq null$}{
                $m \leftarrow find(m \in M \rightarrow m.body = l.body)$\;
                $m.body \leftarrow \tm{l.body, b.body, r.body}$\;
                $m \leftarrow find(m \in M \rightarrow m.body = r.body)$\;
            }
            \uElseIf{$l \neq null \lor r \neq null$}{
                \uIf{$l \neq null$}{
                    $r \leftarrow find(r \in D_R \rightarrow r.body = b.body)$\;
                    \lIf{$r \neq null$}{ \rn{b, M} }
                }
                \Else{
                    $l \leftarrow find(l \in D_L \rightarrow l.body = b.body)$\;
                    \lIf{$l \neq null$}{ \rn{b, M} }
                }

                \BlankLine
                $m \leftarrow find(m \in M \rightarrow m.body = l.body)$\;
                $m.body \leftarrow \tm{l.body, b.body, r.body}$\;
                $m \leftarrow find(m \in M \rightarrow m.body = r.body)$\;
            }
            \Else{
                $m \leftarrow find(m \in M \rightarrow m.body = b.body)$\;
            }

            \BlankLine
            \rn{m, M}\;
        }

        \BlankLine
        $A_L \leftarrow \an{$IB_L$, $IB_B$, $E_L$}$\;
        $A_R \leftarrow \an{$IB_R$, $IB_B$, $E_R$}$\;
    \end{algorithm}

    \begin{algorithm}[H]
        \caption{Edited Nodes}

        \KwIn{$IB, IB_B$}
        \KwOut{map associating a deleted base node $b$ in $IB_B$ and its correspondent added branch node $a$ in $IB$}

        \SetKwFunction{sim}{similarity}

        \BlankLine
        $D \leftarrow \{d \in IB_B \mid (\lnot \exists a \in IB)(d.body = a.body)\}$\;
        $A \leftarrow \{a \in IB \mid (\lnot \exists d \in IB_B)(a.body = d.body)\}$\;

        \BlankLine
        $matches \leftarrow \emptyset$\;
        \ForEach{$a \in A$}{
            $S \leftarrow \{d \in D \mid a.body \approx d.body\}$\;
            $b \leftarrow \underset{s \in S}{\operatorname{argmax}} \; (\sim{s.body, a.body})$\;
            \lIf{$b \neq null$}{
                $matches \leftarrow matches \cup \{b: a\}$
            }
        }

        \BlankLine
        \KwRet{matches}
    \end{algorithm}

    \begin{algorithm}[H]
        \caption{Added Nodes}

        \KwIn{$IB, IB_B, E$}
        \KwOut{set of initilization block nodes added by branch}

        \BlankLine
        $A \leftarrow \{n \in IB \mid (\lnot \exists b \in IB_B)(n.body = b.body)\}$\;
        $A \leftarrow \{n \in A \mid (\lnot \exists e \in E)(n.body = e.value.body)\}$\;
        \KwRet{A}\;
    \end{algorithm}

    \begin{algorithm}[H]
        \caption{Deleted Nodes}

        \KwIn{$IB, IB_B, E$}
        \KwOut{set of initialization block nodes deleted by branch}

        \BlankLine
        $D \leftarrow \{b \in IB_B \mid (\lnot \exists n \in IB)(b.body = n.body)\}$\;
        $D \leftarrow \{n \in D \mid (\lnot \exists e \in E)(n.body = e.key.body)\}$\;
        \KwRet{D}\;
    \end{algorithm}
\end{document}